# A2A Orchestrator Container (Orchestrator Only)
FROM registry.access.redhat.com/ubi9/python-311:latest

# Set labels for container metadata
LABEL org.opencontainers.image.title="Mortgage A2A Orchestrator"
LABEL org.opencontainers.image.description="A2A Orchestrator for intelligent routing to specialized agents"
LABEL org.opencontainers.image.vendor="Mortgage Processing System"
LABEL org.opencontainers.image.version="1.0.0"

# Set working directory
WORKDIR /app

# Copy requirements first for better layer caching
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy source code (A2A orchestrator only)
COPY src/mortgage_a2a/ ./src/mortgage_a2a/
COPY prompts/ ./prompts/

# Create directories for runtime data (fix permissions for non-root user)
USER root
RUN mkdir -p /app/logs && chown -R 1001:0 /app/logs && chmod -R g+rwX /app/logs
USER 1001

# Set environment variables
ENV PYTHONPATH=/app/src
ENV PYTHONUNBUFFERED=1

# Expose A2A orchestrator port only
EXPOSE 8000

# Health check for A2A orchestrator
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8000 || exit 1

# Create A2A orchestrator startup script
USER root
RUN cat > /app/start_orchestrator_only.py << 'EOF'
#!/usr/bin/env python3
"""
A2A Orchestrator Only Startup Script
Starts only the A2A orchestrator (no web search agent)
"""
import sys
import logging
import uvicorn

# Add src to Python path
sys.path.insert(0, '/app/src')

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def main():
    """Start only the A2A orchestrator"""
    try:
        from mortgage_a2a.orchestrator_agent import create_mortgage_orchestrator_server
        
        logger.info("🏠 Starting Mortgage A2A Orchestrator on port 8000...")
        app = create_mortgage_orchestrator_server()
        uvicorn.run(app, host="0.0.0.0", port=8000, log_level="info")
    except Exception as e:
        logger.error(f" Orchestrator error: {e}")
        raise

if __name__ == "__main__":
    main()
EOF

RUN chmod +x /app/start_orchestrator_only.py && chown 1001:0 /app/start_orchestrator_only.py
USER 1001

# Run the A2A orchestrator only
CMD ["python", "/app/start_orchestrator_only.py"]
