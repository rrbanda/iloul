# Web Search Agent Container (LlamaStack Integration Only)
FROM registry.access.redhat.com/ubi9/python-311:latest

# Set labels for container metadata
LABEL org.opencontainers.image.title="Web Search Agent"
LABEL org.opencontainers.image.description="Standalone web search agent using LlamaStack API"
LABEL org.opencontainers.image.vendor="Mortgage Processing System"
LABEL org.opencontainers.image.version="1.0.0"

# Set working directory
WORKDIR /app

# Copy requirements first for better layer caching
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy source code (Web search agent only)
COPY src/mortgage_a2a/agents/ ./src/mortgage_a2a/agents/
COPY src/mortgage_a2a/__init__.py ./src/mortgage_a2a/__init__.py

# Create directories for runtime data (fix permissions for non-root user)
USER root
RUN mkdir -p /app/logs && chown -R 1001:0 /app/logs && chmod -R g+rwX /app/logs
USER 1001

# Set environment variables
ENV PYTHONPATH=/app/src
ENV PYTHONUNBUFFERED=1

# Expose web search agent port only
EXPOSE 8002

# Health check for web search agent
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8002 || exit 1

# Create web search agent startup script
USER root
RUN cat > /app/start_web_search_only.py << 'EOF'
#!/usr/bin/env python3
"""
Web Search Agent Only Startup Script
Starts only the web search agent (standalone LlamaStack service)
"""
import sys
import logging
import uvicorn

# Add src to Python path
sys.path.insert(0, '/app/src')

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def main():
    """Start only the web search agent"""
    try:
        from mortgage_a2a.agents.web_search_agent import create_web_search_server
        
        logger.info("🔍 Starting Web Search Agent on port 8002...")
        app = create_web_search_server()
        uvicorn.run(app, host="0.0.0.0", port=8002, log_level="info")
    except Exception as e:
        logger.error(f" Web Search agent error: {e}")
        raise

if __name__ == "__main__":
    main()
EOF

RUN chmod +x /app/start_web_search_only.py && chown 1001:0 /app/start_web_search_only.py
USER 1001

# Run the web search agent only
CMD ["python", "/app/start_web_search_only.py"]
